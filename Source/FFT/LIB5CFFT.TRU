1000 EXTERNAL     !LIB5CFFT.TRU101010201030 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!1040 SUB CONVOLUTION( CONCORFLAG, FORM$, N, NU, Q, R(), TEMPR(), MATK(,), DITK(), TEMPDITK(), XRE(), XIM(), X2RE(), X2IM(), FFTRE(), FFTIM(), FFT2RE(), FFT2IM(), IFFTRE(), IFFTIM(), TEMPRE(), TEMPIM(), TEMP2RE(), TEMP2IM(), KOS(), ZIN(), IBR, XFLAG, X2FLAG, REALFLAGX, FFTFLAG, FFT2FLAG, SYMMFLAG, IFFTFLAG, REALFLAGIFFT, CONVFLAG, T, MODE$, TYPE$, HJWFLAG, KLEEN$ )10501060 CALL BOX54( "C", Z0$, N, CONCORFLAG )10701080 IF Z0$ = "Q" THEN LET MMENU = 110901100 IF MMENU = 0 AND HJWFLAG = 1 THEN11101120   CALL BOX59( CRT$ )11301140   IF CRT$ = "R" THEN1150     LET HJWFLAG = 01160     CALL CLEARFFT2( FFT2RE(), FFT2IM(), FFT2FLAG )1170   ELSE IF CRT$ = "Q" THEN1180     LET MMENU = 11190   END IF1200 END IF12101220 IF MMENU = 0 AND (TYPE$ = "PUL" OR MODE$ = "DISC") THEN12301240   FOR K = 0 TO N - 11250     LET TEMPRE(K) = ABS(XRE(K))1260     LET TEMPIM(K) = ABS(XIM(K))1270     LET A1 = MAX(A1, TEMPRE(K))1280     LET A2 = MAX(A2, TEMPIM(K))1290     IF (MOD(K,256) = 0 AND N <= 1024) OR (MOD(K,1024) = 0 AND N > 1024 AND N <= 4096) OR (MOD(K,4096) = 0 AND N > 4096) THEN PRINT "=";1300   NEXT K1310   IF A1 <> 0 THEN1320     FOR K = 0 TO N - 11330       IF TEMPRE(K) < .01*A1 THEN LET TEMPRE(K) = 01340       IF (MOD(K,256) = 0 AND N <= 1024) OR (MOD(K,1024) = 0 AND N > 1024 AND N <= 4096) OR (MOD(K,4096) = 0 AND N > 4096) THEN PRINT "=";1350     NEXT K1360   END IF1370   IF A2 <> 0 THEN1380     FOR K = 0 TO N - 11390       IF TEMPIM(K) < .01*A2 THEN LET TEMPIM(K) = 01400       IF (MOD(K,256) = 0 AND N <= 1024) OR (MOD(K,1024) = 0 AND N > 1024 AND N <= 4096) OR (MOD(K,4096) = 0 AND N > 4096) THEN PRINT "=";1410     NEXT K1420   END IF1430   LET FLAG   = 01440   LET COUNT1 = 01450   LET COUNT2 = 01460   LET COUNT3 = 01470   FOR K = 0 TO N - 11480     IF TEMPRE(K) = 0 AND TEMPIM(K) = 0 THEN1490       IF FLAG = 0 THEN1500         LET COUNT3 = COUNT3 + 11510       ELSE IF FLAG = 1 THEN1520         LET COUNT1 = COUNT1 + 11530       END IF1540     ELSE IF TEMPRE(K) <> 0 OR TEMPIM(K) <> 0 THEN1550       LET FLAG = 11560       LET COUNT2 = MAX(COUNT1, COUNT2)1570       LET COUNT1 = 01580     END IF1590     IF (MOD(K,256) = 0 AND N <= 1024) OR (MOD(K,1024) = 0 AND N > 1024 AND N <= 4096) OR (MOD(K,4096) = 0 AND N > 4096) THEN PRINT "=";1600   NEXT K1610   LET COUNT3 = COUNT3 + COUNT11620   LET COUNT2 = MAX(COUNT2, COUNT3)1630   LET PNUM = N - COUNT21640   FOR K = 0 TO N - 11650     LET TEMP2RE(K) = ABS(X2RE(K))1660     LET TEMP2IM(K) = ABS(X2IM(K))1670     LET A3 = MAX(A3, TEMP2RE(K))1680     LET A4 = MAX(A4, TEMP2IM(K))1690     IF (MOD(K,256) = 0 AND N <= 1024) OR (MOD(K,1024) = 0 AND N > 1024 AND N <= 4096) OR (MOD(K,4096) = 0 AND N > 4096) THEN PRINT "=";1700   NEXT K1710   IF A3 <> 0 THEN1720     FOR K = 0 TO N - 11730       IF TEMP2RE(K) < .001*A3 THEN LET TEMP2RE(K) = 01740       IF (MOD(K,256) = 0 AND N <= 1024) OR (MOD(K,1024) = 0 AND N > 1024 AND N <= 4096) OR (MOD(K,4096) = 0 AND N > 4096) THEN PRINT "=";1750     NEXT K1760   END IF1770   IF A4 <> 0 THEN1780     FOR K = 0 TO N - 11790       IF TEMP2IM(K) < .001*A4 THEN LET TEMP2IM(K) = 01800       IF (MOD(K,256) = 0 AND N <= 1024) OR (MOD(K,1024) = 0 AND N > 1024 AND N <= 4096) OR (MOD(K,4096) = 0 AND N > 4096) THEN PRINT "=";1810     NEXT K1820   END IF1830   LET FLAG   = 01840   LET COUNT1 = 01850   LET COUNT2 = 01860   LET COUNT3 = 01870   FOR K = 0 TO N - 11880     IF TEMP2RE(K) = 0 AND TEMP2IM(K) = 0 THEN1890       IF FLAG = 0 THEN1900         LET COUNT3 = COUNT3 + 11910       ELSE IF FLAG = 1 THEN1920         LET COUNT1 = COUNT1 + 11930       END IF1940     ELSE IF TEMP2RE(K) <> 0 OR TEMP2IM(K) <> 0 THEN1950       LET FLAG = 11960       LET COUNT2 = MAX(COUNT1, COUNT2)1970       LET COUNT1 = 01980     END IF1990     IF (MOD(K,256) = 0 AND N <= 1024) OR (MOD(K,1024) = 0 AND N > 1024 AND N <= 4096) OR (MOD(K,4096) = 0 AND N > 4096) THEN PRINT "=";2000   NEXT K2010   LET COUNT3 = COUNT3 + COUNT12020   LET COUNT2 = MAX(COUNT2, COUNT3)2030   LET QNUM = N - COUNT2204020502060   IF PNUM + QNUM > N + 1 THEN20702080     CALL BOX25( PNUM, QNUM, N, ZT$, CONCORFLAG )20902100     IF ZT$ = "Q" THEN2110       LET MMENU = 121202130       CALL TW_WKILL( 2 )2140       CALL TW_WSWITCH( 1 )21502160     END IF2170   END IF2180 END IF21902200 IF MMENU = 0 THEN2210   LET TIMESTART = TIME2220   IF FORM$ = "POWEROF2" THEN2230     CALL RUNFFT1( N, NU, XRE(), XIM(), X2RE(), X2IM(), TEMPRE(), TEMPIM(), FFTRE(), FFTIM(), FFT2RE(), FFT2IM(), KOS(), ZIN(), IBR, XFLAG, X2FLAG, REALFLAGX, FFTFLAG, FFT2FLAG, SYMMFLAG )2240   ELSE IF FORM$ = "COMPOSITE" OR FORM$ = "PRIME" THEN2250     CALL RUNFFT2( N, Q, R(), TEMPR(), MATK(,), DITK(), TEMPDITK(), XRE(), XIM(), X2RE(), X2IM(), TEMPRE(), TEMPIM(), TEMP2RE(), TEMP2IM(), FFTRE(), FFTIM(), FFT2RE(), FFT2IM(), KOS(), ZIN(), XFLAG, X2FLAG, REALFLAGX, FFTFLAG, FFT2FLAG, SYMMFLAG, FORM$ )2260   END IF2270   LET FFTFLAG = 12280   ! FFT OF PRIMARY  X  IS IN PRIMARY22902300   FOR K = 0 TO N - 12310     LET FFT2RE(K) = FFTRE(K)         ! PUT PRIMARY FFT IN SECONDARY2320     LET FFT2IM(K) = FFTIM(K)2330   NEXT K23402350   FOR K = 0 TO N - 12360     LET TEMPRE(K) = XRE(K)           ! PUT PRIMARY X IN SECONDARY2370     LET TEMPIM(K) = XIM(K)           ! AND SECONDARY X IN PRIMARY2380     LET XRE(K)    = X2RE(K)2390     LET XIM(K)    = X2IM(K)2400     LET X2RE(K)   = TEMPRE(K)2410     LET X2IM(K)   = TEMPIM(K)2420   NEXT K24302440   ! NOW RUNNING FFT ON SECONDARY  X2450   IF FORM$ = "POWEROF2" THEN2460     CALL RUNFFT1( N, NU, XRE(), XIM(), X2RE(), X2IM(), TEMPRE(), TEMPIM(), FFTRE(), FFTIM(), FFT2RE(), FFT2IM(), KOS(), ZIN(), IBR, XFLAG, X2FLAG, REALFLAGX, FFTFLAG, FFT2FLAG, SYMMFLAG )2470   ELSE IF FORM$ = "COMPOSITE" OR FORM$ = "PRIME" THEN2480     CALL RUNFFT2( N, Q, R(), TEMPR(), MATK(,), DITK(), TEMPDITK(), XRE(), XIM(), X2RE(), X2IM(), TEMPRE(), TEMPIM(), TEMP2RE(), TEMP2IM(), FFTRE(), FFTIM(), FFT2RE(), FFT2IM(), KOS(), ZIN(), XFLAG, X2FLAG, REALFLAGX, FFTFLAG, FFT2FLAG, SYMMFLAG, FORM$ )2490   END IF2500   LET FFT2FLAG = 12510   ! FFT OF SECONDARY  X  IS NOW IN PRIMARY25202530   FOR K = 0 TO N - 1            ! PUT PRIMARY X BACK INTO PRIMARY2540     LET TEMPRE(K) = XRE(K)      ! AND SECONDARY X INTO SECONDARY2550     LET TEMPIM(K) = XIM(K)2560     LET XRE(K)    = X2RE(K)2570     LET XIM(K)    = X2IM(K)2580     LET X2RE(K)   = TEMPRE(K)2590     LET X2IM(K)   = TEMPIM(K)2600   NEXT K26102620   FOR K = 0 TO N - 12630     LET TEMPRE(K) = FFTRE(K)     ! PUT PRIMARY FFT IN PRIMARY2640     LET TEMPIM(K) = FFTIM(K)     ! AND SECONDARY IN SECONDARY2650     LET FFTRE(K)  = FFT2RE(K)2660     LET FFTIM(K)  = FFT2IM(K)2670     LET FFT2RE(K) = TEMPRE(K)2680     LET FFT2IM(K) = TEMPIM(K)2690   NEXT K270027102720   IF CONCORFLAG = 0 THEN         !CONJUGATE FFT IF CORRELATION2730     FOR K = 0 TO N - 12740       LET FFTIM(K) = -FFTIM(K)2750     NEXT K2760   END IF27702780               ! PERFORM COMPLEX MULTIPLICATION OF PRIMARY AND SECONDARY FFT'S2790   FOR K = 0 TO N - 12800     LET TEMPRE(K) = (FFTRE(K)*FFT2RE(K) - FFTIM(K)*FFT2IM(K))2810     LET TEMPIM(K) = (FFTIM(K)*FFT2RE(K) + FFTRE(K)*FFT2IM(K))2820   NEXT K2830   FOR K = 0 TO N - 12840     LET FFTRE(K) = TEMPRE(K)2850     LET FFTIM(K) = TEMPIM(K)2860   NEXT K28702880                       ! INVERT PRIMARY FFT TO OBTAIN IFFT2890   IF FORM$ = "POWEROF2" THEN2900     CALL RUNIFFT1( N, NU, FFTRE(), FFTIM(), FFT2RE(), FFT2IM(), TEMPRE(), TEMPIM(), TEMP2RE(), TEMP2IM, IFFTRE(), IFFTIM(), KOS(), ZIN(), IBR, FFTFLAG, FFT2FLAG, SYMMFLAG, IFFTFLAG, REALFLAGIFFT, CONVFLAG )2910   ELSE IF FORM$ = "COMPOSITE" OR FORM$ = "PRIME" THEN2920     CALL RUNIFFT2( N, Q, R(), TEMPR(), MATK(,), DITK(), TEMPDITK(), FFTRE(), FFTIM(), FFT2RE(), FFT2IM(), TEMPRE(), TEMPIM(), TEMP2RE(), TEMP2IM(), IFFTRE(), IFFTIM(), KOS(), ZIN(), FFTFLAG, FFT2FLAG, SYMMFLAG, IFFTFLAG, REALFLAGIFFT, FORM$, CONVFLAG )2930   END IF29402950   LET CONVFLAG = 129602970   LET TIMEEND = TIME2980   LET TOTALTIME = TIMEEND - TIMESTART29903000   CALL BOX57( "F", TOTALTIME, CONCORFLAG )30103020   PRINT3030   CALL TESTFFTDATA( N, FFTRE(), FFTIM(), FFT2RE(), FFT2IM(), TEMP2RE(), TEMP2IM(), FFTFLAG, FFT2FLAG, SYMMFLAG, HJWFLAG, KLEEN$ )3040   CALL TESTIFFTDATA( N, IFFTRE(), IFFTIM(), TEMP2RE(), TEMP2IM(), IFFTFLAG, REALFLAGIFFT, CONVFLAG, KLEEN$ )30503060   CALL TW_WKILL( 2 )3070   CALL TW_WSWITCH( 1 )30803090 END IF31003110 END SUB !CONVOLUTION3120 !!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!3130